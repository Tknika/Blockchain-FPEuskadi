<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'includes/head.html' %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <title>Formaciones App</title>
</head>
<body>
    {% include 'includes/menu.html' %}

    <div class="content">
        <div class="container-fluid mt-5 px-5">
            <h3>Mis Formaciones</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Nombre de la Formación</th>
                        <th>Módulo</th>
                        <th>Ciclo formativo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for form in formakuntzak %}
                    <tr>
                        <td>{{ form[0] }}</td>
                        <td>{{ form[1] }}</td>
                        <td>{{ form[2] }}</td>
                        <td>{{ form[3] }}</td>
                        {% if form[5] == 0 %}
                        <td>
                            <a role="button" class="btn btn-success btn-sm" href="/formakuntza_aldatu/{{ form[4] }}" title="Formakuntza aldatu / Editar formación"><i class="bi bi-pencil"></i></a>
                            <a role="button" class=" btn btn-danger btn-sm" href="/formakuntza_ezabatu/{{ form[4] }}" title="Rormakutnza ezabatu / Eliminar formación"><i class="bi bi-x-octagon"></i></a>
                            <button class="btn btn-warning btn-sm ms-5 btn-blockchain" data-idfor="{{ form[4] }}" title="Agiriak Blockchainean gorde/ Guardar certificados en la Blockchain">
                                <span class="btn-text"><i class="bi bi-archive"></i></span>
                                <span class="btn-loading d-none">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Procesando...
                                </span>
                            </button>
                        </td>
                        {% else %}
                        <td>
                            <a role="button" class="btn btn-primary btn-sm" href="/formakuntza_ikusi/{{ form[4] }}" title="Formakuntza ikusi / Ver formación"><i class="bi bi-eye"></i></a>
                        </td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <button class="btn btn-primary" onclick="window.location.href='/formakuntza_berria/'">Crear Nueva Formación</button>
        </div>
    </div>
    {% include 'includes/footer.html' %}
    <script src="/static/js/pasahitza_aldatu.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar el clic en los botones de blockchain
            document.querySelectorAll('.btn-blockchain').forEach(button => {
                button.addEventListener('click', function() {
                    const idfor = this.dataset.idfor;
                    const btnText = this.querySelector('.btn-text');
                    const btnLoading = this.querySelector('.btn-loading');
                    
                    // Encontrar la fila actual y deshabilitar todos los botones de la fila
                    const row = this.closest('tr');
                    const allButtons = row.querySelectorAll('a[role="button"], button');
                    allButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.6';
                    });
                    
                    // Deshabilitar el botón y mostrar spinner
                    this.disabled = true;
                    btnText.classList.add('d-none');
                    btnLoading.classList.remove('d-none');
                    
                    // Realizar la petición AJAX
                    fetch(`/sortu_zihurtagiriak/${idfor}`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            // Mostrar mensaje de éxito
                            alert('Proceso iniciado correctamente. Los certificados se están generando en segundo plano.');
                            // Recargar la página después de un breve delay para mostrar el cambio
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            throw new Error('Error en la respuesta del servidor');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al procesar la solicitud. Intente nuevamente.');
                        // Restaurar todos los botones de la fila en caso de error
                        const row = this.closest('tr');
                        const allButtons = row.querySelectorAll('a[role="button"], button');
                        allButtons.forEach(btn => {
                            btn.disabled = false;
                            btn.style.pointerEvents = '';
                            btn.style.opacity = '';
                        });
                        
                        // Restaurar el botón de blockchain específicamente
                        btnText.classList.remove('d-none');
                        btnLoading.classList.add('d-none');
                    });
                });
            });
        });
    </script>
</body>
</html>
